<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Malware Scanner - Aegis DLP</title>
    <link rel="icon" type="image/png" href="{{ url_for('static', filename='favicon.png') }}">

    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>

    <!-- Lucide Icons -->
    <script src="https://unpkg.com/lucide@latest"></script>

    <!-- Google Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap"
        rel="stylesheet">

    <style>
        * {
            font-family: 'Inter', sans-serif;
        }

        body {
            background: linear-gradient(135deg, #0f0c29, #302b63, #24243e);
            min-height: 100vh;
        }

        .glass-card {
            background: rgba(30, 30, 46, 0.8);
            backdrop-filter: blur(20px);
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .upload-zone {
            border: 2px dashed rgba(99, 102, 241, 0.5);
            transition: all 0.3s ease;
        }

        .upload-zone:hover,
        .upload-zone.dragover {
            border-color: #6366f1;
            background: rgba(99, 102, 241, 0.1);
        }

        .btn-primary {
            background: linear-gradient(135deg, #6366f1, #8b5cf6);
            transition: all 0.3s ease;
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 40px -10px rgba(99, 102, 241, 0.5);
        }

        .btn-primary:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }

        .tab-btn.active {
            background: rgba(99, 102, 241, 0.2);
            color: #6366f1;
            border-color: #6366f1;
        }

        .animate-spin {
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            from {
                transform: rotate(0deg);
            }

            to {
                transform: rotate(360deg);
            }
        }

        .toast-container {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 1000;
        }

        .toast {
            padding: 1rem 1.5rem;
            border-radius: 0.75rem;
            margin-bottom: 0.5rem;
            animation: slideIn 0.3s ease;
        }

        @keyframes slideIn {
            from {
                transform: translateX(100%);
                opacity: 0;
            }

            to {
                transform: translateX(0);
                opacity: 1;
            }
        }
    </style>
</head>

<body class="text-gray-100">
    <!-- Navigation -->
    <nav class="fixed w-full top-0 z-50 bg-gray-900/80 backdrop-blur-lg border-b border-gray-800">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex items-center justify-between h-16">
                <a href="/" class="flex items-center gap-3">
                    <div
                        class="w-10 h-10 rounded-xl bg-gradient-to-br from-red-500 to-pink-600 flex items-center justify-center">
                        <i data-lucide="shield-alert" class="w-5 h-5 text-white"></i>
                    </div>
                    <span
                        class="text-xl font-bold bg-gradient-to-r from-red-400 to-pink-500 bg-clip-text text-transparent">
                        Malware Scanner
                    </span>
                </a>

                <div class="flex items-center gap-8">
                    <a href="/" class="flex items-center gap-2 text-gray-300 hover:text-white transition-colors">
                        <i data-lucide="home" class="w-4 h-4"></i> Home
                    </a>
                </div>

                <div id="api-status" class="flex items-center gap-2 px-4 py-2 rounded-full glass-card">
                    <div class="w-2 h-2 rounded-full bg-gray-500" id="status-indicator"></div>
                    <span class="text-sm text-gray-400" id="status-text">Checking API...</span>
                </div>
            </div>
        </div>
    </nav>

    <!-- Toast Container -->
    <div class="toast-container" id="toast-container"></div>

    <!-- Main Content -->
    <main class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8 pt-24">
        <div class="space-y-8">
            <!-- Header -->
            <div class="text-center space-y-4">
                <h1
                    class="text-4xl font-bold bg-gradient-to-r from-red-400 via-pink-500 to-purple-500 bg-clip-text text-transparent">
                    VirusTotal Malware Scanner
                </h1>
                <p class="text-gray-400 max-w-2xl mx-auto">
                    Scan files and URLs for malware, viruses, and security threats using 70+ antivirus engines powered
                    by VirusTotal API.
                </p>
            </div>

            <!-- Tab Navigation -->
            <div class="flex justify-center gap-4">
                <button type="button" id="tab-file"
                    class="tab-btn active px-6 py-3 rounded-xl border border-gray-700 text-gray-300 hover:text-white font-semibold transition-all flex items-center gap-2">
                    <i data-lucide="file" class="w-5 h-5"></i> File Scanner
                </button>
                <button type="button" id="tab-url"
                    class="tab-btn px-6 py-3 rounded-xl border border-gray-700 text-gray-300 hover:text-white font-semibold transition-all flex items-center gap-2">
                    <i data-lucide="link" class="w-5 h-5"></i> URL Scanner
                </button>
                <button type="button" id="tab-history"
                    class="tab-btn px-6 py-3 rounded-xl border border-gray-700 text-gray-300 hover:text-white font-semibold transition-all flex items-center gap-2">
                    <i data-lucide="clock" class="w-5 h-5"></i> Scan History
                </button>
            </div>

            <!-- File Scanner Tab -->
            <div id="panel-file" class="tab-panel">
                <!-- Upload Zone -->
                <div class="glass-card rounded-2xl p-8">
                    <div id="upload-zone" class="upload-zone rounded-xl p-12 text-center cursor-pointer">
                        <div id="upload-content">
                            <div
                                class="w-20 h-20 mx-auto mb-6 rounded-2xl bg-gradient-to-br from-red-500/20 to-pink-500/20 flex items-center justify-center">
                                <i data-lucide="cloud-upload" class="w-10 h-10 text-red-400"></i>
                            </div>
                            <h3 class="text-xl font-semibold mb-2 text-white">Drag & Drop Files Here</h3>
                            <p class="text-gray-400 mb-4">or click to browse your files</p>
                            <p class="text-sm text-gray-500">Accepts files up to 32MB each</p>
                        </div>
                        <div id="upload-progress" class="hidden">
                            <div class="w-16 h-16 mx-auto mb-4">
                                <i data-lucide="loader-2" class="w-16 h-16 text-red-400 animate-spin"></i>
                            </div>
                            <h3 class="text-xl font-semibold mb-2 text-white">Uploading & Scanning...</h3>
                            <p class="text-gray-400" id="progress-text">Preparing files...</p>
                        </div>
                    </div>
                    <input type="file" id="file-input" multiple class="hidden">
                </div>

                <!-- Selected Files Preview -->
                <div id="selected-files" class="hidden mt-6">
                    <div class="flex items-center justify-between mb-4">
                        <h3 class="text-lg font-semibold text-white">Selected Files</h3>
                        <button type="button" id="clear-files"
                            class="text-sm text-gray-400 hover:text-white transition-colors flex items-center gap-1">
                            <i data-lucide="x-circle" class="w-4 h-4"></i> Clear All
                        </button>
                    </div>
                    <div id="files-list" class="space-y-2"></div>
                    <button type="button" id="scan-button"
                        class="btn-primary w-full mt-4 py-3 rounded-xl font-semibold text-white flex items-center justify-center gap-2">
                        <i data-lucide="shield-check" class="w-5 h-5"></i>
                        <span>Scan Files</span>
                    </button>
                </div>

                <!-- Results Section -->
                <div id="results-section" class="hidden mt-6 space-y-4">
                    <div class="flex items-center justify-between">
                        <h3 class="text-xl font-semibold text-white">Scan Results</h3>
                        <button type="button" id="clear-results"
                            class="text-sm text-gray-400 hover:text-white transition-colors flex items-center gap-1">
                            <i data-lucide="trash-2" class="w-4 h-4"></i> Clear Results
                        </button>
                    </div>
                    <div id="results-container" class="space-y-4"></div>
                </div>
            </div>

            <!-- URL Scanner Tab -->
            <div id="panel-url" class="tab-panel hidden">
                <div class="glass-card rounded-2xl p-8">
                    <div class="space-y-6">
                        <div class="relative">
                            <div class="absolute inset-y-0 left-0 pl-4 flex items-center pointer-events-none">
                                <i data-lucide="link" class="w-5 h-5 text-gray-400"></i>
                            </div>
                            <input type="url" id="url-input"
                                placeholder="Enter URL, domain, or IP address (e.g., https://example.com)"
                                class="w-full pl-12 pr-4 py-4 bg-gray-900/50 border border-gray-700 rounded-xl text-white placeholder-gray-500 focus:outline-none focus:border-red-500 focus:ring-1 focus:ring-red-500 transition-all">
                        </div>

                        <div class="flex items-center gap-4">
                            <button type="button" id="scan-url-btn"
                                class="btn-primary flex-1 py-4 rounded-xl font-semibold text-white flex items-center justify-center gap-2">
                                <i data-lucide="shield-check" class="w-5 h-5"></i>
                                <span>Scan URL</span>
                            </button>
                            <button type="button" id="clear-url-btn"
                                class="px-6 py-4 rounded-xl border border-gray-700 text-gray-400 hover:text-white hover:border-gray-500 transition-all">
                                <i data-lucide="x" class="w-5 h-5"></i>
                            </button>
                        </div>
                    </div>

                    <!-- Quick Examples -->
                    <div class="mt-6 pt-6 border-t border-gray-700">
                        <p class="text-sm text-gray-500 mb-3">Quick examples:</p>
                        <div class="flex flex-wrap gap-2">
                            <button type="button"
                                class="example-url px-3 py-1.5 rounded-lg bg-red-500/10 text-red-400 text-sm hover:bg-red-500/20 transition-colors"
                                data-url="https://google.com">google.com</button>
                            <button type="button"
                                class="example-url px-3 py-1.5 rounded-lg bg-red-500/10 text-red-400 text-sm hover:bg-red-500/20 transition-colors"
                                data-url="https://github.com">github.com</button>
                            <button type="button"
                                class="example-url px-3 py-1.5 rounded-lg bg-red-500/10 text-red-400 text-sm hover:bg-red-500/20 transition-colors"
                                data-url="https://virustotal.com">virustotal.com</button>
                        </div>
                    </div>
                </div>

                <!-- URL Scanning Indicator -->
                <div id="url-scanning-indicator" class="hidden mt-6">
                    <div class="glass-card rounded-xl p-8 text-center">
                        <div class="w-16 h-16 mx-auto mb-4">
                            <i data-lucide="loader-2" class="w-16 h-16 text-red-400 animate-spin"></i>
                        </div>
                        <h3 class="text-xl font-semibold text-white mb-2">Scanning URL...</h3>
                        <p class="text-gray-400" id="scanning-url">Analyzing security threats</p>
                    </div>
                </div>

                <!-- URL Result Section -->
                <div id="url-result-section" class="hidden mt-6 space-y-4">
                    <h3 class="text-xl font-semibold text-white">Scan Result</h3>
                    <div id="url-result-container"></div>
                </div>
            </div>

            <!-- History Tab -->
            <div id="panel-history" class="tab-panel hidden">
                <!-- Stats Overview -->
                <div class="grid grid-cols-4 gap-4 mb-6">
                    <div class="glass-card rounded-xl p-6">
                        <div class="flex items-center gap-4">
                            <div class="w-12 h-12 rounded-xl bg-red-500/20 flex items-center justify-center">
                                <i data-lucide="shield-check" class="w-6 h-6 text-red-400"></i>
                            </div>
                            <div>
                                <p class="text-2xl font-bold text-white" id="stat-total">0</p>
                                <p class="text-sm text-gray-400">Total Scans</p>
                            </div>
                        </div>
                    </div>
                    <div class="glass-card rounded-xl p-6">
                        <div class="flex items-center gap-4">
                            <div class="w-12 h-12 rounded-xl bg-green-500/20 flex items-center justify-center">
                                <i data-lucide="check-circle" class="w-6 h-6 text-green-400"></i>
                            </div>
                            <div>
                                <p class="text-2xl font-bold text-green-400" id="stat-safe">0</p>
                                <p class="text-sm text-gray-400">Safe</p>
                            </div>
                        </div>
                    </div>
                    <div class="glass-card rounded-xl p-6">
                        <div class="flex items-center gap-4">
                            <div class="w-12 h-12 rounded-xl bg-yellow-500/20 flex items-center justify-center">
                                <i data-lucide="alert-triangle" class="w-6 h-6 text-yellow-400"></i>
                            </div>
                            <div>
                                <p class="text-2xl font-bold text-yellow-400" id="stat-suspicious">0</p>
                                <p class="text-sm text-gray-400">Suspicious</p>
                            </div>
                        </div>
                    </div>
                    <div class="glass-card rounded-xl p-6">
                        <div class="flex items-center gap-4">
                            <div class="w-12 h-12 rounded-xl bg-red-500/20 flex items-center justify-center">
                                <i data-lucide="shield-x" class="w-6 h-6 text-red-400"></i>
                            </div>
                            <div>
                                <p class="text-2xl font-bold text-red-400" id="stat-malicious">0</p>
                                <p class="text-sm text-gray-400">Malicious</p>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- History List -->
                <div class="glass-card rounded-2xl overflow-hidden">
                    <div id="history-list" class="divide-y divide-gray-700/50">
                        <div class="p-12 text-center text-gray-400">
                            <i data-lucide="loader-2" class="w-8 h-8 mx-auto mb-2 animate-spin"></i>
                            <p>Loading scan history...</p>
                        </div>
                    </div>

                    <!-- Pagination -->
                    <div class="px-6 py-4 border-t border-gray-700 flex items-center justify-between">
                        <p class="text-sm text-gray-400">
                            Showing <span id="showing-count">0</span> of <span id="total-results">0</span> results
                        </p>
                        <div class="flex items-center gap-2">
                            <button type="button" id="prev-btn"
                                class="px-4 py-2 rounded-lg border border-gray-700 text-gray-400 hover:text-white hover:border-gray-500 transition-all disabled:opacity-50 disabled:cursor-not-allowed">
                                <i data-lucide="chevron-left" class="w-4 h-4"></i>
                            </button>
                            <span class="px-4 py-2 text-sm text-white">
                                Page <span id="current-page">1</span> of <span id="total-pages">1</span>
                            </span>
                            <button type="button" id="next-btn"
                                class="px-4 py-2 rounded-lg border border-gray-700 text-gray-400 hover:text-white hover:border-gray-500 transition-all disabled:opacity-50 disabled:cursor-not-allowed">
                                <i data-lucide="chevron-right" class="w-4 h-4"></i>
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <!-- Footer -->
    <footer class="glass-card mt-auto py-6 mt-12">
        <div class="max-w-7xl mx-auto px-4 text-center text-gray-500 text-sm">
            <p>Powered by <a href="https://www.virustotal.com" target="_blank"
                    class="text-red-400 hover:underline">VirusTotal API</a> | Part of Aegis DLP Security Suite</p>
        </div>
    </footer>

    <script>
        // Initialize Lucide icons
        lucide.createIcons();

        // ========== UTILITY FUNCTIONS ==========
        function showToast(message, type) {
            type = type || 'info';
            var container = document.getElementById('toast-container');
            var toast = document.createElement('div');
            var colors = {
                'success': 'bg-green-500/20 border border-green-500/30 text-green-400',
                'error': 'bg-red-500/20 border border-red-500/30 text-red-400',
                'warning': 'bg-yellow-500/20 border border-yellow-500/30 text-yellow-400',
                'info': 'bg-blue-500/20 border border-blue-500/30 text-blue-400'
            };
            toast.className = 'toast glass-card ' + colors[type];
            toast.textContent = message;
            container.appendChild(toast);
            setTimeout(function () { toast.remove(); }, 3000);
        }

        function formatFileSize(bytes) {
            if (bytes === 0) return '0 Bytes';
            var k = 1024;
            var sizes = ['Bytes', 'KB', 'MB', 'GB'];
            var i = Math.floor(Math.log(bytes) / Math.log(k));
            return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
        }

        function formatDate(dateString) {
            var date = new Date(dateString);
            return date.toLocaleDateString('en-US', {
                year: 'numeric', month: 'short', day: 'numeric',
                hour: '2-digit', minute: '2-digit'
            });
        }

        function getThreatClass(level) {
            var classes = {
                'safe': 'text-green-400',
                'low': 'text-yellow-400',
                'medium': 'text-orange-400',
                'high': 'text-red-400',
                'unknown': 'text-gray-400'
            };
            return classes[level] || classes['unknown'];
        }

        // ========== API STATUS ==========
        async function checkApiStatus() {
            try {
                var response = await fetch('/api/malware/status');
                var data = await response.json();
                var indicator = document.getElementById('status-indicator');
                var text = document.getElementById('status-text');

                if (data.connected) {
                    indicator.className = 'w-2 h-2 rounded-full bg-green-500';
                    text.textContent = 'API Connected';
                    text.className = 'text-sm text-green-400';
                } else if (!data.api_configured) {
                    indicator.className = 'w-2 h-2 rounded-full bg-yellow-500';
                    text.textContent = 'No API Key';
                    text.className = 'text-sm text-yellow-400';
                } else {
                    indicator.className = 'w-2 h-2 rounded-full bg-red-500';
                    text.textContent = 'Disconnected';
                    text.className = 'text-sm text-red-400';
                }
            } catch (error) {
                console.error('Failed to check API status:', error);
            }
        }

        // ========== TAB NAVIGATION ==========
        var tabs = ['file', 'url', 'history'];
        tabs.forEach(function (tab) {
            document.getElementById('tab-' + tab).onclick = function () {
                tabs.forEach(function (t) {
                    document.getElementById('tab-' + t).classList.remove('active');
                    document.getElementById('panel-' + t).classList.add('hidden');
                });
                this.classList.add('active');
                document.getElementById('panel-' + tab).classList.remove('hidden');

                if (tab === 'history') loadHistory();
                lucide.createIcons();
            };
        });

        // ========== FILE SCANNER ==========
        (function () {
            var selectedFiles = [];
            var uploadZone = document.getElementById('upload-zone');
            var fileInput = document.getElementById('file-input');
            var uploadContent = document.getElementById('upload-content');
            var uploadProgress = document.getElementById('upload-progress');
            var progressText = document.getElementById('progress-text');
            var selectedFilesDiv = document.getElementById('selected-files');
            var filesList = document.getElementById('files-list');
            var scanButton = document.getElementById('scan-button');
            var clearFilesBtn = document.getElementById('clear-files');
            var resultsSection = document.getElementById('results-section');
            var resultsContainer = document.getElementById('results-container');
            var clearResultsBtn = document.getElementById('clear-results');

            uploadZone.onclick = function (e) {
                e.preventDefault();
                fileInput.click();
            };

            uploadZone.ondragover = function (e) {
                e.preventDefault();
                e.stopPropagation();
                this.classList.add('dragover');
                return false;
            };

            uploadZone.ondragleave = function (e) {
                e.preventDefault();
                e.stopPropagation();
                this.classList.remove('dragover');
                return false;
            };

            uploadZone.ondrop = function (e) {
                e.preventDefault();
                e.stopPropagation();
                this.classList.remove('dragover');
                var files = e.dataTransfer.files;
                if (files && files.length > 0) handleFiles(files);
                return false;
            };

            fileInput.onchange = function () {
                if (this.files && this.files.length > 0) handleFiles(this.files);
            };

            function handleFiles(files) {
                selectedFiles = [];
                for (var i = 0; i < files.length; i++) selectedFiles.push(files[i]);
                updateFilesList();
            }

            function updateFilesList() {
                if (selectedFiles.length === 0) {
                    selectedFilesDiv.classList.add('hidden');
                    return;
                }
                selectedFilesDiv.classList.remove('hidden');
                var html = '';
                for (var i = 0; i < selectedFiles.length; i++) {
                    var file = selectedFiles[i];
                    html += '<div class="glass-card rounded-lg p-3 flex items-center justify-between">';
                    html += '<div class="flex items-center gap-3">';
                    html += '<div class="w-10 h-10 rounded-lg bg-red-500/20 flex items-center justify-center">';
                    html += '<i data-lucide="file" class="w-5 h-5 text-red-400"></i>';
                    html += '</div>';
                    html += '<div>';
                    html += '<p class="font-medium text-white truncate max-w-xs">' + file.name + '</p>';
                    html += '<p class="text-sm text-gray-400">' + formatFileSize(file.size) + '</p>';
                    html += '</div></div>';
                    html += '<button type="button" class="remove-file text-gray-400 hover:text-red-400 p-2" data-index="' + i + '">';
                    html += '<i data-lucide="x" class="w-5 h-5"></i></button></div>';
                }
                filesList.innerHTML = html;
                lucide.createIcons();

                var removeButtons = filesList.querySelectorAll('.remove-file');
                for (var j = 0; j < removeButtons.length; j++) {
                    removeButtons[j].onclick = function () {
                        var index = parseInt(this.getAttribute('data-index'));
                        selectedFiles.splice(index, 1);
                        updateFilesList();
                    };
                }
            }

            clearFilesBtn.onclick = function (e) {
                e.preventDefault();
                selectedFiles = [];
                updateFilesList();
                fileInput.value = '';
            };

            clearResultsBtn.onclick = function (e) {
                e.preventDefault();
                resultsContainer.innerHTML = '';
                resultsSection.classList.add('hidden');
            };

            scanButton.onclick = async function (e) {
                e.preventDefault();
                if (selectedFiles.length === 0) {
                    showToast('Please select files to scan', 'warning');
                    return;
                }

                uploadContent.classList.add('hidden');
                uploadProgress.classList.remove('hidden');
                scanButton.disabled = true;
                scanButton.innerHTML = '<i data-lucide="loader-2" class="w-5 h-5 animate-spin"></i><span>Scanning...</span>';
                lucide.createIcons();
                resultsSection.classList.remove('hidden');

                for (var i = 0; i < selectedFiles.length; i++) {
                    var file = selectedFiles[i];
                    progressText.textContent = 'Scanning ' + (i + 1) + ' of ' + selectedFiles.length + ': ' + file.name;
                    var pendingId = 'pending-' + Date.now() + '-' + i;
                    var pendingHtml = '<div id="' + pendingId + '" class="glass-card rounded-xl p-6">';
                    pendingHtml += '<div class="flex items-center gap-4">';
                    pendingHtml += '<div class="w-12 h-12 rounded-xl bg-red-500/20 flex items-center justify-center">';
                    pendingHtml += '<i data-lucide="loader-2" class="w-6 h-6 text-red-400 animate-spin"></i></div>';
                    pendingHtml += '<div><h4 class="font-semibold text-white">' + file.name + '</h4>';
                    pendingHtml += '<p class="text-sm text-gray-400">Scanning...</p></div></div></div>';
                    resultsContainer.innerHTML = pendingHtml + resultsContainer.innerHTML;
                    lucide.createIcons();

                    var formData = new FormData();
                    formData.append('file', file);

                    try {
                        var response = await fetch('/api/malware/scan/file', { method: 'POST', body: formData });
                        var data = await response.json();
                        var pendingCard = document.getElementById(pendingId);
                        if (pendingCard) {
                            pendingCard.outerHTML = createResultCard(data.result || data);
                            lucide.createIcons();
                        }
                        if (data.success) showToast('Scan complete: ' + file.name, 'success');
                        else showToast('Scan failed: ' + (data.error || 'Unknown error'), 'error');
                    } catch (error) {
                        var pendingCard = document.getElementById(pendingId);
                        if (pendingCard) {
                            pendingCard.outerHTML = createErrorCard(file.name, error.message);
                            lucide.createIcons();
                        }
                        showToast('Error scanning ' + file.name, 'error');
                    }
                }

                uploadContent.classList.remove('hidden');
                uploadProgress.classList.add('hidden');
                scanButton.disabled = false;
                scanButton.innerHTML = '<i data-lucide="shield-check" class="w-5 h-5"></i><span>Scan Files</span>';
                lucide.createIcons();
                selectedFiles = [];
                updateFilesList();
                fileInput.value = '';
                showToast('All scans completed!', 'success');
            };

            function createResultCard(result) {
                var threatLevel = result.threat_level || 'unknown';
                var threatClass = getThreatClass(threatLevel);
                var threatLabels = { 'safe': 'Safe', 'low': 'Low Risk', 'medium': 'Medium Risk', 'high': 'High Risk', 'unknown': 'Unknown' };
                var threatIcons = { 'safe': 'shield-check', 'low': 'alert-triangle', 'medium': 'alert-circle', 'high': 'shield-x', 'unknown': 'help-circle' };
                var bgColors = { 'safe': 'border-green-500/30 bg-green-500/10', 'low': 'border-yellow-500/30 bg-yellow-500/10', 'medium': 'border-orange-500/30 bg-orange-500/10', 'high': 'border-red-500/30 bg-red-500/10', 'unknown': 'border-gray-500/30' };

                var html = '<div class="glass-card rounded-xl p-6 border ' + (bgColors[threatLevel] || '') + '">';
                html += '<div class="flex items-start justify-between mb-4">';
                html += '<div class="flex items-center gap-4">';
                html += '<div class="w-12 h-12 rounded-xl bg-gradient-to-br from-red-500/20 to-pink-500/20 flex items-center justify-center">';
                html += '<i data-lucide="' + (threatIcons[threatLevel] || 'file') + '" class="w-6 h-6 ' + threatClass + '"></i></div>';
                html += '<div><h4 class="font-semibold text-white truncate max-w-md">' + (result.target_name || 'Unknown') + '</h4>';
                html += '<p class="text-sm text-gray-400">' + (result.file_hash ? result.file_hash.substring(0, 16) + '...' : 'N/A') + '</p></div></div>';
                html += '<span class="px-3 py-1 rounded-full text-sm font-medium ' + threatClass + ' ' + (bgColors[threatLevel] || '') + '">' + (threatLabels[threatLevel] || 'Unknown') + '</span></div>';
                html += '<div class="grid grid-cols-4 gap-4 mb-4">';
                html += '<div class="text-center p-3 rounded-lg bg-red-500/10"><p class="text-2xl font-bold text-red-400">' + (result.malicious_count || 0) + '</p><p class="text-xs text-gray-400">Malicious</p></div>';
                html += '<div class="text-center p-3 rounded-lg bg-yellow-500/10"><p class="text-2xl font-bold text-yellow-400">' + (result.suspicious_count || 0) + '</p><p class="text-xs text-gray-400">Suspicious</p></div>';
                html += '<div class="text-center p-3 rounded-lg bg-gray-500/10"><p class="text-2xl font-bold text-gray-400">' + (result.undetected_count || 0) + '</p><p class="text-xs text-gray-400">Undetected</p></div>';
                html += '<div class="text-center p-3 rounded-lg bg-green-500/10"><p class="text-2xl font-bold text-green-400">' + (result.harmless_count || 0) + '</p><p class="text-xs text-gray-400">Harmless</p></div></div>';
                html += '<div class="flex items-center justify-between text-sm">';
                html += '<span class="text-gray-400">' + (result.file_size ? formatFileSize(result.file_size) : 'N/A') + '</span>';
                if (result.vt_link) {
                    html += '<a href="' + result.vt_link + '" target="_blank" class="text-red-400 hover:text-pink-400 transition-colors flex items-center gap-1">';
                    html += 'View on VirusTotal <i data-lucide="external-link" class="w-4 h-4"></i></a>';
                }
                html += '</div></div>';
                return html;
            }

            function createErrorCard(filename, error) {
                var html = '<div class="glass-card rounded-xl p-6 border border-red-500/30 bg-red-500/10">';
                html += '<div class="flex items-center gap-4">';
                html += '<div class="w-12 h-12 rounded-xl bg-red-500/20 flex items-center justify-center">';
                html += '<i data-lucide="x-circle" class="w-6 h-6 text-red-400"></i></div>';
                html += '<div><h4 class="font-semibold text-red-400">' + filename + '</h4>';
                html += '<p class="text-sm text-gray-400">' + (error || 'Scan failed') + '</p></div></div></div>';
                return html;
            }
        })();

        // ========== URL SCANNER ==========
        (function () {
            var urlInput = document.getElementById('url-input');
            var scanUrlBtn = document.getElementById('scan-url-btn');
            var clearUrlBtn = document.getElementById('clear-url-btn');
            var scanningIndicator = document.getElementById('url-scanning-indicator');
            var scanningUrl = document.getElementById('scanning-url');
            var resultSection = document.getElementById('url-result-section');
            var resultContainer = document.getElementById('url-result-container');

            var exampleBtns = document.querySelectorAll('.example-url');
            for (var i = 0; i < exampleBtns.length; i++) {
                exampleBtns[i].onclick = function () {
                    urlInput.value = this.getAttribute('data-url');
                    urlInput.focus();
                };
            }

            clearUrlBtn.onclick = function (e) {
                e.preventDefault();
                urlInput.value = '';
                urlInput.focus();
            };

            scanUrlBtn.onclick = async function (e) {
                e.preventDefault();
                var url = urlInput.value.trim();
                if (!url) {
                    showToast('Please enter a URL', 'warning');
                    return;
                }

                scanningIndicator.classList.remove('hidden');
                scanningUrl.textContent = url;
                scanUrlBtn.disabled = true;
                scanUrlBtn.innerHTML = '<i data-lucide="loader-2" class="w-5 h-5 animate-spin"></i><span>Scanning...</span>';
                lucide.createIcons();
                resultSection.classList.add('hidden');

                try {
                    var response = await fetch('/api/malware/scan/url', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ url: url })
                    });
                    var data = await response.json();
                    scanningIndicator.classList.add('hidden');

                    if (data.success) {
                        resultSection.classList.remove('hidden');
                        resultContainer.innerHTML = createUrlResultCard(data.result);
                        lucide.createIcons();
                        showToast('URL scan completed!', 'success');
                    } else {
                        showToast(data.error || 'Scan failed', 'error');
                    }
                } catch (error) {
                    scanningIndicator.classList.add('hidden');
                    showToast('Failed to scan URL', 'error');
                }

                scanUrlBtn.disabled = false;
                scanUrlBtn.innerHTML = '<i data-lucide="shield-check" class="w-5 h-5"></i><span>Scan URL</span>';
                lucide.createIcons();
            };

            function createUrlResultCard(result) {
                var threatLevel = result.threat_level || 'unknown';
                var threatClass = getThreatClass(threatLevel);
                var threatLabels = { 'safe': 'Safe', 'low': 'Low Risk', 'medium': 'Medium Risk', 'high': 'High Risk', 'unknown': 'Pending' };
                var threatIcons = { 'safe': 'shield-check', 'low': 'alert-triangle', 'medium': 'alert-circle', 'high': 'shield-x', 'unknown': 'clock' };
                var bgColors = { 'safe': 'border-green-500/30 bg-green-500/10', 'low': 'border-yellow-500/30 bg-yellow-500/10', 'medium': 'border-orange-500/30 bg-orange-500/10', 'high': 'border-red-500/30 bg-red-500/10', 'unknown': 'border-gray-500/30' };

                var html = '<div class="glass-card rounded-xl p-6 border ' + (bgColors[threatLevel] || '') + '">';
                html += '<div class="flex items-start justify-between mb-4">';
                html += '<div class="flex items-center gap-4">';
                html += '<div class="w-14 h-14 rounded-xl bg-gradient-to-br from-red-500/20 to-pink-500/20 flex items-center justify-center">';
                html += '<i data-lucide="' + (threatIcons[threatLevel] || 'link') + '" class="w-8 h-8 ' + threatClass + '"></i></div>';
                html += '<div><h4 class="font-semibold text-lg text-white">' + (result.target_name || 'Unknown') + '</h4>';
                html += '<p class="text-sm text-gray-400">' + (result.created_at ? formatDate(result.created_at) : '') + '</p></div></div>';
                html += '<span class="px-4 py-2 rounded-full text-sm font-medium ' + threatClass + ' ' + (bgColors[threatLevel] || '') + '">' + (threatLabels[threatLevel] || 'Unknown') + '</span></div>';
                html += '<div class="grid grid-cols-4 gap-4 mb-6">';
                html += '<div class="text-center p-4 rounded-xl bg-red-500/10 border border-red-500/20"><p class="text-3xl font-bold text-red-400">' + (result.malicious_count || 0) + '</p><p class="text-sm text-gray-400 mt-1">Malicious</p></div>';
                html += '<div class="text-center p-4 rounded-xl bg-yellow-500/10 border border-yellow-500/20"><p class="text-3xl font-bold text-yellow-400">' + (result.suspicious_count || 0) + '</p><p class="text-sm text-gray-400 mt-1">Suspicious</p></div>';
                html += '<div class="text-center p-4 rounded-xl bg-gray-500/10 border border-gray-500/20"><p class="text-3xl font-bold text-gray-400">' + (result.undetected_count || 0) + '</p><p class="text-sm text-gray-400 mt-1">Undetected</p></div>';
                html += '<div class="text-center p-4 rounded-xl bg-green-500/10 border border-green-500/20"><p class="text-3xl font-bold text-green-400">' + (result.harmless_count || 0) + '</p><p class="text-sm text-gray-400 mt-1">Harmless</p></div></div>';
                html += '<div class="flex items-center justify-between">';
                html += '<div class="text-sm text-gray-400">Scanned by <span class="text-white font-medium">' + (result.total_engines || 0) + '</span> engines</div>';
                if (result.vt_link) {
                    html += '<a href="' + result.vt_link + '" target="_blank" class="btn-primary px-4 py-2 rounded-lg text-sm font-medium text-white flex items-center gap-2">';
                    html += '<i data-lucide="external-link" class="w-4 h-4"></i> View Full Report</a>';
                }
                html += '</div></div>';
                return html;
            }
        })();

        // ========== HISTORY ==========
        var currentPage = 1;
        var totalPages = 1;

        async function loadHistory() {
            try {
                var response = await fetch('/api/malware/history?page=' + currentPage + '&per_page=10');
                var data = await response.json();
                if (data.success) {
                    totalPages = data.pages || 1;
                    updateStats(data.results);
                    displayResults(data.results);
                    updatePagination(data);
                }
            } catch (error) {
                console.error('Failed to load history:', error);
                document.getElementById('history-list').innerHTML = '<div class="p-12 text-center text-red-400"><p>Failed to load scan history</p></div>';
            }
        }

        function displayResults(results) {
            var historyList = document.getElementById('history-list');
            if (!results || results.length === 0) {
                historyList.innerHTML = '<div class="p-12 text-center text-gray-400"><i data-lucide="inbox" class="w-12 h-12 mx-auto mb-2"></i><p>No scan results found</p></div>';
                lucide.createIcons();
                return;
            }

            var html = '';
            for (var i = 0; i < results.length; i++) {
                var result = results[i];
                var threatLevel = result.threat_level || 'unknown';
                var threatClass = getThreatClass(threatLevel);
                var threatLabels = { 'safe': 'Safe', 'low': 'Low Risk', 'medium': 'Medium Risk', 'high': 'High Risk', 'unknown': 'Pending' };
                var bgColors = { 'safe': 'bg-green-500/10 border-green-500/30', 'low': 'bg-yellow-500/10 border-yellow-500/30', 'medium': 'bg-orange-500/10 border-orange-500/30', 'high': 'bg-red-500/10 border-red-500/30', 'unknown': '' };

                html += '<div class="p-4 hover:bg-white/5 transition-colors">';
                html += '<div class="flex items-center justify-between">';
                html += '<div class="flex items-center gap-4">';
                html += '<div class="w-10 h-10 rounded-lg ' + (result.scan_type === 'file' ? 'bg-red-500/20' : 'bg-pink-500/20') + ' flex items-center justify-center">';
                html += '<i data-lucide="' + (result.scan_type === 'file' ? 'file' : 'link') + '" class="w-5 h-5 ' + (result.scan_type === 'file' ? 'text-red-400' : 'text-pink-400') + '"></i></div>';
                html += '<div><p class="font-medium text-white truncate max-w-md">' + result.target_name + '</p>';
                html += '<p class="text-xs text-gray-500">' + (result.created_at ? formatDate(result.created_at) : '') + '</p></div></div>';
                html += '<div class="flex items-center gap-4">';
                html += '<div class="text-right"><span class="text-red-400 font-semibold">' + (result.malicious_count || 0) + '</span>';
                html += '<span class="text-gray-500 mx-1">/</span><span class="text-gray-400">' + (result.total_engines || 0) + '</span></div>';
                html += '<span class="px-3 py-1 rounded-full text-xs font-medium border ' + threatClass + ' ' + (bgColors[threatLevel] || '') + '">' + (threatLabels[threatLevel] || 'Unknown') + '</span>';
                if (result.vt_link) {
                    html += '<a href="' + result.vt_link + '" target="_blank" class="text-gray-400 hover:text-red-400 transition-colors"><i data-lucide="external-link" class="w-4 h-4"></i></a>';
                }
                html += '</div></div></div>';
            }
            historyList.innerHTML = html;
            lucide.createIcons();
        }

        function updateStats(results) {
            var stats = { total: results.length, safe: 0, suspicious: 0, malicious: 0 };
            for (var i = 0; i < results.length; i++) {
                var level = results[i].threat_level;
                if (level === 'safe') stats.safe++;
                else if (level === 'low' || level === 'medium') stats.suspicious++;
                else if (level === 'high') stats.malicious++;
            }
            document.getElementById('stat-total').textContent = stats.total;
            document.getElementById('stat-safe').textContent = stats.safe;
            document.getElementById('stat-suspicious').textContent = stats.suspicious;
            document.getElementById('stat-malicious').textContent = stats.malicious;
        }

        function updatePagination(data) {
            document.getElementById('current-page').textContent = data.current_page || 1;
            document.getElementById('total-pages').textContent = data.pages || 1;
            document.getElementById('total-results').textContent = data.total || 0;
            document.getElementById('showing-count').textContent = data.results ? data.results.length : 0;
            document.getElementById('prev-btn').disabled = (data.current_page || 1) <= 1;
            document.getElementById('next-btn').disabled = (data.current_page || 1) >= (data.pages || 1);
        }

        document.getElementById('prev-btn').onclick = function () {
            if (currentPage > 1) { currentPage--; loadHistory(); }
        };
        document.getElementById('next-btn').onclick = function () {
            if (currentPage < totalPages) { currentPage++; loadHistory(); }
        };

        // Initialize
        document.addEventListener('DOMContentLoaded', function () {
            checkApiStatus();
            lucide.createIcons();
        });
    </script>

    <!-- AI Chatbot Widget -->
    <link rel="stylesheet" href="{{ url_for('static', filename='css/chatbot.css') }}">
    <script src="https://cdn.socket.io/4.7.2/socket.io.min.js"></script>
    <script>
        window.SENTINELX_PAGE_CONTEXT = {
            page_type: 'malware_scanner',
            feature: 'VirusTotal Malware Scanner',
            description: 'Scan files and URLs for malware using 70+ antivirus engines'
        };
    </script>
    <script src="{{ url_for('static', filename='js/chatbot.js') }}"></script>
</body>

</html>